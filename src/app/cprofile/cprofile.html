<div *ngIf="customer" class="profile-card">

  <!-- ===== PROFILE HEADER ===== -->
  <div class="profile-header">
    <h2>{{ customer.name }}</h2>
    <p><strong>üì± Mobile:</strong> {{ customer.mobile }}</p>
  </div>

  <!-- ===== SUMMARY ===== -->
  <div class="summary-flex">
    <div class="summary-item given">
      <p>Total Given</p>
      <h2>‚Çπ{{ totalGiven }}</h2>
    </div>
    <div class="summary-item taken">
      <p>Total Taken</p>
      <h2>‚Çπ{{ totalTaken }}</h2>
    </div>
    <div class="summary-item final">
      <p>Final Balance</p>
      <h2>‚Çπ{{ finalBalance }}</h2>
    </div>
  </div>

  <div class="branch-btns" style="margin-top: 10px;">
    <button (click)="selectBranch('ALL')">All</button>
    <button *ngFor="let b of branches" (click)="selectBranch(b)">{{ b }}</button>
  </div>

  <!-- ===== DATE FILTER ===== -->
  <div class="date-filter">
    <div class="filter-group">
      <label>Month:</label>
      <select [(ngModel)]="selectedMonth" (change)="applyFilters()">
        <option value="ALL">All Months</option>
        <option *ngFor="let month of months" [value]="month.value">{{ month.label }}</option>
      </select>
    </div>

    <div class="filter-group">
      <label>Year:</label>
      <select [(ngModel)]="selectedYear" (change)="applyFilters()">
        <option value="ALL">All Years</option>
        <option *ngFor="let year of years" [value]="year">{{ year }}</option>
      </select>
    </div>

    <button class="reset-btn" (click)="resetFilters()">Reset Filters</button>
  </div>

  <!-- ===== ACTION BUTTONS ===== -->
  <div class="btn-row">
    <button class="btn-give" (click)="openPopup('give')">You Gave</button>
    <button class="btn-got" (click)="openPopup('get')">You Got</button>
  </div>

  <!-- ===== TRANSACTIONS ===== -->
  <h3 class="txn-title">Transaction History</h3>

  <div class="txn-item" *ngFor="let t of finalTransactionList">

    <div class="txn-top">
      <div class="txn-left">

        <!-- TYPE -->
        <strong [class.green]="t.type === 'give'" [class.red]="t.type === 'get'">
          {{ t.type === 'give' ? 'You Gave' : 'You Got' }}
        </strong>

        <!-- DATE -->
        <div class="txn-row">
          <b>Returndate:</b> {{ t.returnDate | date:'dd MMM yyyy' }}
        </div>

        <!-- BRANCH -->
        <div class="txn-row">
          <b>Branch:</b> {{ t.hotelBranchName }}
        </div>

        <!-- PAYMENT MODE -->


        <!-- DESCRIPTION -->
        <div class="txn-row">
          <b>Description:</b> {{ t.description || '-' }}
        </div>
        <div class="txn-row">
          <b>Bill No:</b> {{ t.billno || '-' }}
        </div>
        <div class="txn-row small">
          <b>Date:</b> {{ t.updatedAt | date:'dd MMM yyyy, hh:mm a' }}
        </div>
      </div>

      <div class="txn-right" style="display: grid;">
        <i class="fa-solid fa-trash trash-btn" (click)="deleteTransaction(t)"></i>
        <div class="amount">
          ‚Çπ{{ t.Rs }} <span style="font-size: 12px; color: rgb(11, 138, 0);">{{ t.paymentMode | uppercase }}</span>
        </div>
      </div>
    </div>

    <!-- SCREENSHOT -->
    <div *ngIf="t.paymentScreenshot" class="img-row">
      <img [src]="t.paymentScreenshot" class="txn-thumb" (click)="openImage(t.paymentScreenshot)" />
      <p class="view-text">Tap to View</p>
    </div>

  </div>
</div>

<!-- ================= POPUP FORM ================= -->
<div class="popup" *ngIf="showPopup" (click)="closePopup()">
  <div class="popup-box" (click)="$event.stopPropagation()">

    <!-- Modal Header -->
    <div class="modal-header">
      <h3>{{ type === 'give' ? 'üí∏ You Gave Money' : 'üí∞ You Got Money' }}</h3>
      <button class="close-btn" (click)="closePopup()">
        <i class="fa-solid fa-times"></i>
      </button>
    </div>

    <!-- Form Content -->
    <div class="modal-body">

      <!-- Amount Field -->
      <div class="form-group">
        <label class="form-label">Amount <span class="required">*</span></label>
        <div class="input-wrapper">
          <span class="input-icon">‚Çπ</span>
          <input type="number" [(ngModel)]="amount" placeholder="Enter amount" class="form-input with-icon" />
        </div>
      </div>

      <!-- Description Field -->
      <div class="form-group">
        <label class="form-label">Description</label>
        <input type="text" [(ngModel)]="description" placeholder="Enter description" class="form-input" />
      </div>

      <!-- Bill Number Field -->
      <div class="form-group">
        <label class="form-label">Bill Number</label>
        <input type="text" [(ngModel)]="billno" placeholder="Enter bill number (optional)" class="form-input" />
      </div>

      <!-- Date Fields Row -->
      <div class="form-row">
        <div class="form-group half">
          <label class="form-label">Return Date</label>
          <input type="date" [(ngModel)]="returnDate" class="form-input" />
        </div>

        <div class="form-group half">
          <label class="form-label">Transaction Date <span class="required">*</span></label>
          <input type="date" [(ngModel)]="transactionDate" class="form-input" />
        </div>
      </div>

      <!-- Branch & Payment Mode Row -->
      <div class="form-row">
        <div class="form-group half">
          <label class="form-label">Branch <span class="required">*</span></label>
          <select [(ngModel)]="selectedBranch" class="form-select">
            <option value="" disabled>Select Branch</option>
            <option *ngFor="let branch of branches" [value]="branch">{{ branch }}</option>
          </select>
        </div>

        <div class="form-group half">
          <label class="form-label">Payment Mode</label>
          <select [(ngModel)]="paymentMode" class="form-select">
            <option value="cash">üíµ Cash</option>
            <option value="online">üí≥ Online</option>
            <!-- <option value="cheque">üìù Cheque</option> -->
          </select>
        </div>
      </div>

      <!-- File Upload -->
      <div class="form-group">
        <label class="form-label">Payment Screenshot</label>
        <div class="file-input-wrapper">
          <input type="file" accept="image/*" (change)="onImageSelect($event)" id="fileInput" class="file-input" />
          <label for="fileInput" class="file-label">
            <i class="fa-solid fa-cloud-upload"></i>
            <span>{{ selectedImage ? selectedImage.name : 'Choose file or drag here' }}</span>
          </label>
        </div>
      </div>

    </div>

    <!-- Modal Footer -->
    <div class="modal-footer">
      <button class="btn btn-cancel" (click)="closePopup()">Cancel</button>
      <button class="btn btn-submit" (click)="submitTransaction()">
        <i class="fa-solid fa-check"></i> Save Transaction
      </button>
    </div>

  </div>
</div>

<!-- üî• Delete Confirmation Modal -->
<div class="delete-modal" *ngIf="showDeleteModal">
  <div class="delete-modal-content">
    <div class="delete-icon">üóëÔ∏è</div>
    <h3>Delete Transaction?</h3>
    <p>Are you sure you want to delete this transaction? This action cannot be undone.</p>

    <div class="delete-modal-actions">
      <button class="cancel-btn" (click)="closeDeleteModal()">Cancel</button>
      <button class="delete-btn" (click)="confirmDelete()">Delete</button>
    </div>
  </div>
</div>

<!-- üî• Toast Notification -->
<div class="toast-notification" [class.show]="toast.show" [ngClass]="toast.type">
  <div class="toast-icon">
    <span *ngIf="toast.type === 'success'">‚úì</span>
    <span *ngIf="toast.type === 'error'">‚úó</span>
    <span *ngIf="toast.type === 'info'">‚Ñπ</span>
  </div>
  <div class="toast-message">{{ toast.message }}</div>
</div>